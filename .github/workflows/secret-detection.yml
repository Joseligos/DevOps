name: Secret Detection

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main
  schedule:
    # Run secret detection every day at 4 AM UTC
    - cron: '0 4 * * *'

jobs:
  secret-detection:
    name: Detect Secrets in Code
    runs-on: ubuntu-latest
    
    permissions:
      contents: read
      security-events: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v3
        with:
          fetch-depth: 0  # Fetch full history to scan all commits

      - name: Make script executable
        run: chmod +x scripts/check-secrets.sh

      - name: Run custom secret detection
        run: ./scripts/check-secrets.sh
        continue-on-error: true  # Don't fail the workflow, just report findings

      - name: Run TruffleHog secret detection
        uses: trufflesecurity/trufflehog@main
        with:
          path: ./
          base: ${{ github.event.repository.default_branch }}
          head: HEAD
          extra_args: --json --only-verified
        continue-on-error: true

      - name: Run GitGuardian scanning (optional)
        uses: GitGuardian/ggshield-action@v1
        env:
          GITGUARDIAN_API_KEY: ${{ secrets.GITGUARDIAN_API_KEY }}
        continue-on-error: true
        if: github.event_name == 'push' || github.event_name == 'pull_request'
